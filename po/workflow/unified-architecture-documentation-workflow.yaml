# çµ±ä¸€æ¶æ§‹æ–‡æª”å·¥ä½œæµç¨‹
# ç”¨æ–¼ architecture-documenter agent çš„å®Œæ•´åŸ·è¡Œæµç¨‹
# æ•´åˆå¯¦ä½œèˆ‡è¨ˆåŠƒï¼Œç”ŸæˆåŒæ­¥çš„æ¶æ§‹æ–‡æª”

# ğŸ”„ å·¥ä½œæµç¨‹Todo Listè£½ä½œæµç¨‹
todo_list_creation:
  description: "åœ¨é–‹å§‹åŸ·è¡Œä»»ä½•å·¥ä½œæµç¨‹æ­¥é©Ÿä¹‹å‰ï¼ŒAIå¿…é ˆå…ˆå‰µå»ºåŒ…å«æ‰€æœ‰workflowæ­¥é©Ÿçš„todo list"
  importance: "critical"
  
  process_steps:
    1_analyze_workflow:
      description: "åˆ†æå·¥ä½œæµç¨‹çµæ§‹ - ä»”ç´°é–±è®€æ•´å€‹workflowæ–‡ä»¶ï¼Œè­˜åˆ¥æ‰€æœ‰éšæ®µã€æ­¥é©Ÿå’Œä»»å‹™"
      priority: "high"
      
    2_extract_tasks:
      description: "æå–é—œéµä»»å‹™ - å°‡æ¯å€‹éšæ®µçš„æ ¸å¿ƒä»»å‹™è½‰æ›ç‚ºå…·é«”çš„todoé …ç›®"
      priority: "high"
      
    3_set_priorities:
      description: "è¨­å®šå„ªå…ˆç´š - æ ¹æ“šä»»å‹™çš„é‡è¦æ€§å’Œä¾è³´é—œä¿‚è¨­å®šå„ªå…ˆç´šï¼ˆhigh/medium/lowï¼‰"
      priority: "medium"
      
    4_create_todo_list:
      description: "å‰µå»ºTodo List - ä½¿ç”¨todo_writeå·¥å…·å‰µå»ºåŒ…å«æ‰€æœ‰æ­¥é©Ÿçš„çµæ§‹åŒ–todo list"
      priority: "high"
      
    5_execute_workflow:
      description: "é–‹å§‹åŸ·è¡Œ - æŒ‰ç…§todo listçš„é †åºåŸ·è¡Œä»»å‹™ï¼Œä¸¦åŠæ™‚æ›´æ–°ç‹€æ…‹"
      priority: "high"
  
  requirements:
    coverage: "æ¯å€‹ä¸»è¦éšæ®µéƒ½æ‡‰è©²æœ‰å°æ‡‰çš„todoé …ç›®"
    validation: "é—œéµçš„é©—è­‰æª¢æŸ¥é»å¿…é ˆåŒ…å«åœ¨todo listä¸­"
    priority_setting: "è¨­å®šåˆç†çš„å„ªå…ˆç´šï¼Œç¢ºä¿ä¾è³´é—œä¿‚å¾—åˆ°å°Šé‡"
    status_tracking: "åœ¨åŸ·è¡Œéç¨‹ä¸­åŠæ™‚æ›´æ–°todoç‹€æ…‹ï¼ˆpending â†’ in_progress â†’ completedï¼‰"

# åˆ†éš”ç·šï¼Œä»¥ä¸‹ç‚ºåŸå§‹workflowå…§å®¹
---

workflow_name: "unified-architecture-documentation-workflow"
version: "2.2.0"
description: "æ•´åˆç•¶å‰å¯¦ä½œèˆ‡è¨ˆåŠƒï¼Œç”Ÿæˆæœ€æ–°æ¶æ§‹ç¸½è¦½èˆ‡ç´°ç¯€ï¼Œç¢ºä¿æ–‡æª”èˆ‡ä»£ç¢¼åŒæ­¥"

# å·¥ä½œæµç¨‹åŸ·è¡Œè¨­å®š
execution_settings:
  deterministic: true
  parallel_enabled: true
  max_parallel_tasks: 10
  batch_size: 7
  cache_enabled: true
  fail_fast: false  # è¨˜éŒ„éŒ¯èª¤ä½†ä¸ä¸­æ–·
  
# å‰ç½®æ¢ä»¶æª¢æŸ¥
prerequisites:
  required_files:
    # æ ¸å¿ƒé…ç½®æª”æ¡ˆ
    - path: "{project_root}/sunnycore/po/templates/architecture-doc-tmpl.yaml"
      type: "template"
      critical: false  # ç¼ºå¤±æ™‚è¨˜éŒ„è­¦å‘Šä¸¦æŒçºŒ
    - path: "{project_root}/sunnycore/po/enforcement/architecture-documenter-enforcement.md"
      type: "enforcement"
      critical: false
      
  recommended_files:
    # è¦ç¯„æ–‡ä»¶ï¼ˆå»ºè­°å­˜åœ¨ï¼‰
    - path: "{{project_root}}/docs/specs/task.md"
      type: "specification"
    - path: "{{project_root}}/docs/specs/requirements.md"
      type: "specification"
    - path: "{{project_root}}/docs/specs/design.md"
      type: "specification"
      
  optional_directories:
    # è¨ˆåŠƒæ–‡ä»¶ç›®éŒ„
    - path: "{{project_root}}/docs/implementation-plan/"
      type: "plans"
      pattern: "*-plan.*"
    # ç¾æœ‰æ¶æ§‹æ–‡æª”
    - path: "{{project_root}}/docs/architecture/"
      type: "existing_docs"
      
  validation_rules:
    - rule: "project_root_resolved"
      description: "project_root å¿…é ˆè§£æç‚ºæœ‰æ•ˆè·¯å¾‘"
    - rule: "codebase_accessible"
      description: "ä»£ç¢¼åº«å¿…é ˆå¯è®€å–"
    - rule: "output_directory_writable"
      description: "{{project_root}}/docs/architecture/ å¿…é ˆå¯å¯«"

# ä¸»è¦åŸ·è¡Œéšæ®µ
stages:

  # éšæ®µ 1ï¼šç’°å¢ƒæº–å‚™èˆ‡ç¢ºå®šæ€§è¨­å®š
  - name: "preparation"
    description: "è¼‰å…¥è¨­å®šä¸¦æº–å‚™åŸ·è¡Œç’°å¢ƒ"
    parallel: false
    steps:
      - name: "load_template"
        action: "read_file"
        target: "{project_root}/sunnycore/po/templates/architecture-doc-tmpl.yaml"
        required: false
        on_failure: "log_warning"
        
      - name: "load_enforcement"
        action: "read_file"
        target: "{project_root}/sunnycore/po/enforcement/architecture-documenter-enforcement.md"
        required: false
        on_failure: "log_warning"
        
      - name: "verify_output_path"
        action: "ensure_directory"
        target: "{{project_root}}/docs/architecture/"
        permissions: "write"
        
      - name: "verify_diagrams_path"
        action: "ensure_directory"
        target: "{{project_root}}/docs/architecture/diagrams/"
        permissions: "write"

  # éšæ®µ 2ï¼šè¦ç¯„æ–‡ä»¶æ”¶é›†èˆ‡åˆ†æ
  - name: "specification_discovery"
    description: "ä¸¦è¡Œæ”¶é›†ä¸¦åˆ†æè¦ç¯„æ–‡ä»¶"
    parallel: true
    depends_on: ["preparation"]
    steps:
      - name: "load_task_specification"
        action: "read_file"
        target: "{{project_root}}/docs/specs/task.md"
        required: false
        extract_sections: ["objectives", "requirements", "constraints"]
        on_failure: "log_warning"
        
      - name: "load_requirements"
        action: "read_file"
        target: "{{project_root}}/docs/specs/requirements.md"
        required: false
        extract_sections: ["functional_requirements", "non_functional_requirements"]
        on_failure: "log_warning"
        
      - name: "load_design_specifications"
        action: "read_file"
        target: "{{project_root}}/docs/specs/design.md"
        required: false
        extract_sections: ["architecture", "components", "interfaces", "data_models"]
        on_failure: "log_warning"
        
      - name: "extract_business_context"
        action: "analyze_content"
        sources: ["task_specification", "requirements", "design_specifications"]
        focus: "business_drivers"
        output: "business_context"

  # éšæ®µ 3ï¼šå¯¦æ–½è¨ˆåŠƒæ”¶é›†èˆ‡åˆ†æ
  - name: "implementation_plan_discovery"
    description: "æ”¶é›†ä¸¦åˆ†æå¯¦æ–½è¨ˆåŠƒ"
    parallel: true
    depends_on: ["specification_discovery"]
    steps:
      - name: "scan_implementation_plans"
        action: "glob_search"
        target: "{{project_root}}/docs/implementation-plan/*-plan.*"
        extract_patterns:
          - "architecture"
          - "modules"
          - "interfaces"
          - "data_models"
          - "technology_stack"
        on_empty: "log_info"
        
      - name: "analyze_architectural_decisions"
        action: "extract_decisions"
        sources: "implementation_plans"
        focus: "architecture_decisions"
        include_rationale: true
        output: "architectural_decisions"
        
      - name: "extract_planned_components"
        action: "analyze_structure"
        sources: "implementation_plans"
        extract: "component_definitions"
        output: "planned_components"

  # éšæ®µ 4ï¼šä»£ç¢¼åº«æƒæèˆ‡åˆ†æ
  - name: "codebase_analysis"
    description: "ä¸¦è¡Œæƒæä»£ç¢¼åº«ç²å–å¯¦éš›æ¶æ§‹"
    parallel: true
    depends_on: ["implementation_plan_discovery"]
    steps:
      - name: "scan_interface_definitions"
        action: "grep_search"
        target: "{{project_root}}"
        patterns:
          - "interface\\s+\\w+"  # TypeScript/Go interfaces
          - "class\\s+\\w+.*:"   # Python classes
          - "public\\s+class"    # Java classes
          - "@RestController"    # Spring controllers
          - "app\\.route"        # Flask routes
          - "router\\."          # Express routes
        file_types: ["ts", "tsx", "js", "jsx", "py", "java", "go", "rs"]
        output: "actual_interfaces"
        
      - name: "scan_data_models"
        action: "grep_search"
        target: "{{project_root}}"
        patterns:
          - "CREATE TABLE"       # SQL DDL
          - "class.*Model"       # ORM models
          - "interface.*Entity"  # TypeScript entities
          - "@Entity"           # JPA entities
          - "Schema\\("         # Mongoose schemas
        file_types: ["sql", "py", "ts", "tsx", "java", "js"]
        output: "actual_data_models"
        
      - name: "scan_api_routes"
        action: "grep_search"
        target: "{{project_root}}"
        patterns:
          - "@GetMapping"
          - "@PostMapping"
          - "@PutMapping"
          - "@DeleteMapping"
          - "app\\.(get|post|put|delete)"
          - "router\\.(get|post|put|delete)"
        file_types: ["java", "py", "js", "ts", "tsx"]
        output: "actual_api_routes"
        
      - name: "scan_infrastructure_config"
        action: "glob_search"
        target: "{{project_root}}"
        patterns:
          - "**/docker-compose*.yml"
          - "**/Dockerfile*"
          - "**/k8s/**/*.yaml"
          - "**/terraform/**/*.tf"
          - "**/.env*"
          - "**/application*.yml"
          - "**/application*.properties"
        output: "infrastructure_config"
        
      - name: "analyze_dependency_structure"
        action: "analyze_imports"
        target: "{{project_root}}"
        focus: "module_dependencies"
        output: "dependency_graph"

  # éšæ®µ 5ï¼šæ¶æ§‹æ¨¡å‹å»ºç«‹
  - name: "architecture_modeling"
    description: "åŸºæ–¼æ”¶é›†çš„è³‡è¨Šå»ºç«‹æ¶æ§‹æ¨¡å‹"
    parallel: false
    depends_on: ["codebase_analysis"]
    steps:
      - name: "reconcile_planned_vs_actual"
        action: "compare_architectures"
        planned_source: "planned_components"
        actual_source: ["actual_interfaces", "actual_data_models", "actual_api_routes"]
        identify: "discrepancies"
        output: "architecture_reconciliation"
        
      - name: "build_system_context"
        action: "model_system_context"
        sources: ["business_context", "actual_interfaces", "infrastructure_config"]
        include_external_systems: true
        output: "system_context_model"
        
      - name: "build_container_view"
        action: "model_containers"
        sources: ["infrastructure_config", "dependency_graph", "architectural_decisions"]
        include_data_stores: true
        output: "container_model"
        
      - name: "build_component_view"
        action: "model_components"
        sources: ["actual_interfaces", "planned_components", "dependency_graph"]
        focus: "internal_structure"
        output: "component_model"
        
      - name: "build_data_flow"
        action: "model_data_flow"
        sources: ["actual_api_routes", "actual_data_models", "business_context"]
        trace_user_journeys: true
        output: "data_flow_model"

  # éšæ®µ 6ï¼šåœ–è¡¨ç”Ÿæˆ
  - name: "diagram_generation"
    description: "ç”Ÿæˆ Mermaid æ¶æ§‹åœ–è¡¨"
    parallel: true
    depends_on: ["architecture_modeling"]
    steps:
      - name: "generate_system_context_diagram"
        action: "create_mermaid_diagram"
        type: "graph TD"
        source: "system_context_model"
        title: "System Context Diagram"
        output_file: "{{project_root}}/docs/architecture/diagrams/system-context.mmd"
        
      - name: "generate_container_diagram"
        action: "create_mermaid_diagram"
        type: "graph TB"
        source: "container_model"
        title: "Container Diagram"
        output_file: "{{project_root}}/docs/architecture/diagrams/containers.mmd"
        
      - name: "generate_component_diagram"
        action: "create_mermaid_diagram"
        type: "graph LR"
        source: "component_model"
        title: "Component Diagram"
        output_file: "{{project_root}}/docs/architecture/diagrams/components.mmd"
        
      - name: "generate_data_flow_diagram"
        action: "create_mermaid_diagram"
        type: "sequenceDiagram"
        source: "data_flow_model"
        title: "Data Flow Diagram"
        output_file: "{{project_root}}/docs/architecture/diagrams/data-flow.mmd"
        
      - name: "generate_deployment_diagram"
        action: "create_mermaid_diagram"
        type: "graph TD"
        source: "infrastructure_config"
        title: "Deployment Diagram"
        output_file: "{{project_root}}/docs/architecture/diagrams/deployment.mmd"

  # éšæ®µ 7ï¼šæ–‡æª”å…§å®¹ç”Ÿæˆ
  - name: "documentation_generation"
    description: "æ ¹æ“šæ¨¡æ¿ç”Ÿæˆæ¶æ§‹æ–‡æª”å…§å®¹"
    parallel: false
    depends_on: ["diagram_generation"]
    steps:
      - name: "populate_template"
        action: "template_fill"
        template_source: "architecture-doc-tmpl.yaml"
        data_sources:
          - "system_context_model"
          - "container_model"
          - "component_model"
          - "data_flow_model"
          - "architecture_reconciliation"
          - "architectural_decisions"
        placeholder_handling: "mark_as_na_with_reason"
        
      - name: "add_diagram_references"
        action: "embed_diagrams"
        diagrams:
          - path: "diagrams/system-context.mmd"
            section: "system_overview"
          - path: "diagrams/containers.mmd"
            section: "container_architecture"
          - path: "diagrams/components.mmd"
            section: "component_architecture"
          - path: "diagrams/data-flow.mmd"
            section: "data_flow"
          - path: "diagrams/deployment.mmd"
            section: "deployment"
            
      - name: "add_code_navigation"
        action: "create_code_links"
        sources: ["actual_interfaces", "actual_data_models", "actual_api_routes"]
        link_format: "relative_path_with_line_numbers"
        
      - name: "add_adr_references"
        action: "link_architectural_decisions"
        source: "architectural_decisions"
        adr_directory: "{{project_root}}/docs/architecture/decisions/"
        create_missing_adr_stubs: true
        
      - name: "add_metadata"
        action: "add_metadata"
        fields:
          - "generation_timestamp"
          - "codebase_snapshot_hash"
          - "specification_versions"
          - "discrepancy_count"
          - "coverage_metrics"

  # éšæ®µ 8ï¼šåŒæ­¥æ€§é©—è­‰
  - name: "synchronization_validation"
    description: "é©—è­‰æ–‡æª”èˆ‡å¯¦éš›å¯¦ä½œçš„åŒæ­¥æ€§"
    parallel: false
    depends_on: ["documentation_generation"]
    steps:
      - name: "validate_api_contract_sync"
        action: "validate_consistency"
        documented: "api_specifications"
        actual: "actual_api_routes"
        tolerance: "exact_match"
        output: "api_sync_report"
        
      - name: "validate_data_model_sync"
        action: "validate_consistency"
        documented: "data_model_documentation"
        actual: "actual_data_models"
        tolerance: "structural_match"
        output: "data_model_sync_report"
        
      - name: "validate_component_sync"
        action: "validate_consistency"
        documented: "component_documentation"
        actual: "actual_interfaces"
        tolerance: "interface_match"
        output: "component_sync_report"
        
      - name: "identify_evolution_opportunities"
        action: "analyze_evolution"
        source: "architecture_reconciliation"
        focus: "improvement_opportunities"
        output: "evolution_recommendations"

  # éšæ®µ 9ï¼šè¼¸å‡ºèˆ‡æœ€çµ‚é©—è­‰
  - name: "output_and_validation"
    description: "ç”Ÿæˆæœ€çµ‚æ–‡æª”ä¸¦é€²è¡Œå“è³ªé©—è­‰"
    parallel: false
    depends_on: ["synchronization_validation"]
    steps:
      - name: "validate_content"
        action: "content_validation"
        checks:
          - "no_placeholders_remaining"
          - "all_diagrams_referenced"
          - "code_links_valid"
          - "structure_compliance"
          - "minimum_content_length"
        failure_action: "log_and_continue"
        
      - name: "validate_discrepancy_handling"
        action: "discrepancy_validation"
        checks:
          - "all_discrepancies_documented"
          - "evolution_plans_provided"
          - "risk_assessments_included"
        output: "discrepancy_report"
        
      - name: "write_main_documentation"
        action: "write_file"
        target: "{{project_root}}/docs/architecture/architecture.md"
        backup: true
        backup_path: "{{project_root}}/docs/architecture/architecture-{{timestamp}}.md"
        
      - name: "write_sync_reports"
        action: "write_files"
        targets:
          - file: "{{project_root}}/docs/architecture/sync-reports/api-sync.md"
            content: "api_sync_report"
          - file: "{{project_root}}/docs/architecture/sync-reports/data-model-sync.md"
            content: "data_model_sync_report"
          - file: "{{project_root}}/docs/architecture/sync-reports/component-sync.md"
            content: "component_sync_report"
            
      - name: "update_architecture_index"
        action: "update_index"
        target: "{{project_root}}/docs/architecture/index.md"
        add_entries:
          - "architecture.md"
          - "diagrams/"
          - "sync-reports/"
        include_metadata: true

# æ¶æ§‹åˆ†ææ¨™æº–
analysis_standards:
  interface_detection:
    languages: ["typescript", "javascript", "python", "java", "go", "rust"]
    patterns:
      typescript: ["interface\\s+\\w+", "type\\s+\\w+\\s*="]
      python: ["class\\s+\\w+.*:", "def\\s+\\w+\\("]
      java: ["public\\s+interface", "public\\s+class"]
      
  data_model_detection:
    sources: ["sql_ddl", "orm_models", "schema_definitions"]
    validation: "structural_consistency"
    
  api_route_detection:
    frameworks: ["spring", "flask", "express", "fastapi", "gin"]
    extract: ["method", "path", "parameters", "responses"]
    
  dependency_analysis:
    scope: ["internal_modules", "external_libraries"]
    depth: "full_tree"
    circular_detection: true

# åœ–è¡¨ç”Ÿæˆè¦ç¯„
diagram_specifications:
  system_context:
    type: "graph TD"
    elements: ["system", "users", "external_systems"]
    max_nodes: 15
    
  container:
    type: "graph TB"
    elements: ["services", "databases", "message_queues"]
    include_technologies: true
    
  component:
    type: "graph LR"
    elements: ["modules", "interfaces", "data_stores"]
    show_dependencies: true
    
  data_flow:
    type: "sequenceDiagram"
    trace_user_journeys: true
    include_error_paths: true

# åŒæ­¥æ€§é©—è­‰è¦å‰‡
synchronization_rules:
  api_contracts:
    tolerance: "exact"
    check_methods: ["GET", "POST", "PUT", "DELETE"]
    check_parameters: true
    check_responses: true
    
  data_models:
    tolerance: "structural"
    check_fields: true
    check_types: true
    check_relationships: true
    
  components:
    tolerance: "interface"
    check_public_methods: true
    check_dependencies: true
    
  infrastructure:
    tolerance: "configuration"
    check_services: true
    check_ports: true
    check_volumes: true

# éŒ¯èª¤è™•ç†ç­–ç•¥
error_handling:
  specification_file_missing:
    action: "log_warning"
    continue: true
    use_defaults: true
    
  codebase_scan_failure:
    action: "retry_with_reduced_scope"
    max_retries: 2
    continue: true
    
  diagram_generation_failure:
    action: "create_text_description"
    continue: true
    
  synchronization_mismatch:
    action: "document_discrepancy"
    continue: true
    create_evolution_plan: true

# å“è³ªä¿è­‰æª¢æŸ¥
quality_assurance:
  documentation_completeness:
    required_sections: ["overview", "containers", "components", "data_flow", "deployment"]
    minimum_content_per_section: 100
    
  diagram_quality:
    required_diagrams: ["system-context", "containers", "components"]
    diagram_validation: "mermaid_syntax"
    
  synchronization_quality:
    max_acceptable_discrepancies: 5
    critical_discrepancy_threshold: 0
    
  navigation_quality:
    code_link_validity: 100
    cross_reference_completeness: 90

# ä¸¦è¡Œè™•ç†ç­–ç•¥
parallelization:
  specification_discovery:
    max_concurrent: 5
    timeout_per_task: 15
    
  codebase_analysis:
    max_concurrent: 8
    timeout_per_task: 60
    shared_cache: true
    
  diagram_generation:
    max_concurrent: 5
    timeout_per_task: 30

# å¿«å–ç­–ç•¥
caching:
  codebase_analysis:
    strategy: "content_hash"
    ttl_hours: 6
    invalidation_triggers: ["file_modification", "git_commit"]
    
  specification_analysis:
    strategy: "file_hash"
    ttl_hours: 24
    
  diagram_generation:
    strategy: "model_hash"
    ttl_hours: 12
    
# è¼¸å‡ºé©—è­‰è¦å‰‡
validation_rules:
  content_quality:
    - rule: "all_required_sections_present"
      severity: "error"
    - rule: "code_links_valid"
      severity: "warning"
      threshold: 95
    - rule: "diagrams_render_correctly"
      severity: "error"
      
  synchronization_quality:
    - rule: "critical_discrepancies_resolved"
      severity: "error"
    - rule: "evolution_plans_documented"
      severity: "warning"
    - rule: "adr_links_valid"
      severity: "info"

# æˆåŠŸæŒ‡æ¨™
success_metrics:
  coverage_metrics:
    - "specification_coverage_percentage"
    - "codebase_analysis_completeness"
    - "diagram_generation_success_rate"
    
  quality_metrics:
    - "synchronization_accuracy"
    - "navigation_link_validity"
    - "diagram_syntax_validity"
    
  usability_metrics:
    - "new_developer_onboarding_time"
    - "architecture_decision_traceability"
    - "technical_debt_visibility"

# å¾Œè™•ç†è¡Œå‹•
post_processing:
  architecture_maintenance:
    - action: "schedule_synchronization_checks"
      frequency: "weekly"
    - action: "update_evolution_roadmap"
      based_on: "discrepancy_trends"
      
  continuous_improvement:
    - action: "analyze_documentation_usage"
      source: "access_patterns"
    - action: "identify_documentation_gaps"
      method: "user_feedback_analysis"
    - action: "optimize_diagram_layouts"
      based_on: "readability_metrics"

# åŸ·è¡Œå ±å‘Šæ¨¡æ¿
execution_report:
  summary:
    - "specifications_processed"
    - "codebase_elements_analyzed"
    - "diagrams_generated"
    - "synchronization_discrepancies"
    
  details:
    - "specification_analysis_breakdown"
    - "codebase_scan_results"
    - "diagram_generation_log"
    - "synchronization_validation_report"
    
  recommendations:
    - "architecture_evolution_priorities"
    - "documentation_improvement_suggestions"
    - "synchronization_automation_opportunities"
