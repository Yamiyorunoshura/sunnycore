# 實作計劃

- [ ] 1. 專案初始化和基礎架構建立
  - 建立 TypeScript 專案結構，配置開發環境和依賴管理
  - 整合 nypm API 作為底層套件管理基礎
  - _需求：需求 1_

  - [ ] 1.1 建立 NPM 套件專案結構
    - 初始化 package.json，設定專案基本資訊和依賴
    - 配置 TypeScript 編譯設定和 ESLint 規則
    - 建立基本目錄結構：src/、dist/、tests/
    - _需求：需求 1_

  - [ ] 1.2 整合 nypm 依賴
    - 安裝 nypm 套件並配置 API 整合
    - 實作套件管理器檢測功能測試
    - 建立 nypm API 的 TypeScript 類型定義
    - _需求：需求 1_

  - [ ] 1.3 建立 CLI 入口點
    - 建立 bin/claude-installer.js 作為 CLI 入口
    - 配置 package.json 的 bin 欄位
    - 實作基本命令解析和幫助訊息
    - _需求：需求 1_

- [ ] 2. 核心安裝管理器實作
  - 實作 InstallationManager 抽象類別和 ClaudeInstaller 主要服務
  - 建立文件系統操作和配置管理功能
  - _需求：需求 2, 需求 3_

  - [ ] 2.1 實作 InstallationManager 抽象類別
    - 定義安裝流程的核心介面和抽象方法
    - 實作環境驗證和備份創建的共用邏輯
    - 建立安裝狀態管理機制
    - _需求：需求 2, 需求 3_

  - [ ] 2.2 實作 ClaudeInstaller 主要服務
    - 繼承 InstallationManager，實作具體安裝邏輯
    - 整合 nypm API 處理套件依賴
    - 實作安裝、檢測和回滾方法
    - _需求：需求 2, 需求 3_

  - [ ] 2.3 建立 FileSystemManager 類別
    - 實作跨平台文件操作功能
    - 建立用戶目錄和專案目錄的安裝邏輯
    - 實作文件複製、權限檢查和路徑解析
    - _需求：需求 2, 需求 3_

  - [ ] 2.4 建立 ConfigurationManager 類別
    - 實作安裝配置的讀取和寫入
    - 建立環境檢測和驗證功能
    - 實作安裝狀態的持久化管理
    - _需求：需求 5_

- [ ] 3. 用戶目錄文件安裝功能
  - 實作 agents 和 commands 文件到 ~/.claude/ 目錄的安裝邏輯
  - 處理目錄創建、文件複製和權限管理
  - _需求：需求 2_

  - [ ] 3.1 實作用戶目錄路徑解析
    - 跨平台獲取用戶主目錄路徑
    - 建立 ~/.claude/ 目錄結構
    - 實作目錄存在性檢查和創建邏輯
    - _需求：需求 2_

  - [ ] 3.2 實作 agents 文件安裝
    - 從 NPM 套件中提取 agents 目錄內容
    - 複製所有 .md 文件到 ~/.claude/agents/
    - 保持原有目錄結構和文件屬性
    - _需求：需求 2_

  - [ ] 3.3 實作 commands 文件安裝
    - 從 NPM 套件中提取 commands 目錄內容
    - 複製所有 .md 文件到 ~/.claude/commands/
    - 確保文件完整性和正確性
    - _需求：需求 2_

- [ ] 4. 專案根目錄組件安裝功能
  - 實作 sunnycore 組件到當前專案根目錄的安裝邏輯
  - 自動檢測專案根目錄並處理目錄結構
  - _需求：需求 3_

  - [ ] 4.1 實作專案根目錄檢測
    - 搜尋 package.json 或 .git 目錄確定專案根目錄
    - 實作多層級向上搜尋邏輯
    - 提供手動指定專案根目錄的選項
    - _需求：需求 3_

  - [ ] 4.2 實作 sunnycore 組件安裝
    - 從 NPM 套件中提取 sunnycore 目錄內容
    - 複製完整目錄結構到專案根目錄
    - 保持所有子目錄和文件的層次結構
    - _需求：需求 3_

  - [ ] 4.3 處理文件衝突和覆蓋
    - 檢測目標位置是否已存在 sunnycore 目錄
    - 提供覆蓋、跳過或合併的選項
    - 實作安全的文件替換機制
    - _需求：需求 3_

- [ ] 5. 選擇性文件安裝和過濾機制
  - 實作文件類型過濾，確保只安裝指定的文件類型
  - 排除不需要的文件和目錄
  - _需求：需求 4_

  - [ ] 5.1 建立文件過濾規則
    - 定義需要安裝的文件類型和路徑模式
    - 建立排除規則，過濾掉不需要的文件
    - 實作 glob 模式匹配功能
    - _需求：需求 4_

  - [ ] 5.2 實作選擇性安裝邏輯
    - 根據過濾規則篩選要安裝的文件
    - 跳過不符合條件的文件和目錄
    - 記錄跳過的文件清單供用戶參考
    - _需求：需求 4_

- [ ] 6. 安裝狀態檢測和管理
  - 實作現有安裝的檢測功能
  - 提供安裝狀態查詢和版本比較
  - _需求：需求 5_

  - [ ] 6.1 建立安裝狀態資料庫
    - 實作 SQLite 資料庫初始化
    - 建立 installation_config、file_manifest、backup_records 表
    - 實作資料庫連接和基本 CRUD 操作
    - _需求：需求 5_

  - [ ] 6.2 實作安裝檢測功能
    - 檢查用戶目錄和專案目錄的安裝狀態
    - 比較已安裝文件與套件版本的差異
    - 提供詳細的安裝狀態報告
    - _需求：需求 5_

  - [ ] 6.3 實作版本管理和更新檢測
    - 記錄當前安裝的版本資訊
    - 檢測是否有新版本可用
    - 提供增量更新建議
    - _需求：需求 5_

- [ ] 7. 錯誤處理和回滾機制
  - 實作完整的錯誤處理體系
  - 建立自動備份和回滾功能
  - _需求：需求 6_

  - [ ] 7.1 建立錯誤類別體系
    - 實作 ClaudeInstallerError 基礎錯誤類別
    - 建立各種具體錯誤類別（FileSystemError、PackageManagerError 等）
    - 實作錯誤碼和詳細訊息機制
    - _需求：需求 6_

  - [ ] 7.2 實作自動備份功能
    - 安裝前自動創建現有文件的備份
    - 實作備份文件的壓縮和儲存
    - 建立備份清理和過期管理機制
    - _需求：需求 6_

  - [ ] 7.3 實作回滾機制
    - 安裝失敗時自動觸發回滾
    - 從備份恢復原有文件和目錄結構
    - 清理安裝過程中創建的臨時文件
    - _需求：需求 6_

- [ ] 8. 跨平台兼容性實作
  - 確保在 Windows、macOS、Linux 上的正常運作
  - 處理不同平台的路徑和權限差異
  - _需求：需求 7_

  - [ ] 8.1 實作跨平台路徑處理
    - 使用 Node.js path 模組處理路徑分隔符
    - 實作平台特定的用戶目錄獲取
    - 處理 Windows 和 Unix 系統的路徑差異
    - _需求：需求 7_

  - [ ] 8.2 處理平台特定的權限管理
    - 實作 Windows 和 Unix 系統的權限檢查
    - 處理不同平台的文件屬性設定
    - 實作平台適配的錯誤處理
    - _需求：需求 7_

  - [ ] 8.3 建立跨平台測試環境
    - 配置 GitHub Actions 多平台測試
    - 建立各平台的測試案例
    - 驗證所有功能在不同平台的一致性
    - _需求：需求 7_

- [ ] 9. CLI 使用者介面優化
  - 參考 ni 和 MCP Easy Installer 的設計，實作友善的 CLI 介面
  - 提供互動式選項和進度顯示
  - _需求：需求 1_

  - [ ] 9.1 實作命令列參數解析
    - 使用 commander.js 或類似套件處理 CLI 參數
    - 實作 install、detect、rollback 等子命令
    - 提供詳細的幫助訊息和使用範例
    - _需求：需求 1_

  - [ ] 9.2 建立互動式安裝介面
    - 實作安裝選項的互動式選擇
    - 提供安裝進度條和狀態顯示
    - 實作用戶確認和取消機制
    - _需求：需求 1_

  - [ ] 9.3 優化錯誤訊息和用戶體驗
    - 提供清晰易懂的錯誤訊息
    - 實作彩色輸出和格式化顯示
    - 提供問題解決建議和幫助連結
    - _需求：需求 1_

- [ ] 10. 測試和品質保證
  - 建立完整的測試套件
  - 實作自動化測試和 CI/CD 流程
  - _需求：需求 1-7_

  - [ ] 10.1 建立單元測試
    - 為所有核心類別和方法編寫單元測試
    - 使用 Jest 測試框架和 Mock 功能
    - 達到 90% 以上的程式碼覆蓋率
    - _需求：需求 1-7_

  - [ ] 10.2 實作整合測試
    - 測試與 nypm API 的整合功能
    - 測試文件系統操作的正確性
    - 驗證跨平台功能的一致性
    - _需求：需求 1-7_

  - [ ] 10.3 建立端到端測試
    - 測試完整的安裝和回滾流程
    - 模擬各種錯誤情況和邊界條件
    - 驗證 CLI 介面的使用者體驗
    - _需求：需求 1-7_