# 提示詞工程執行規範（Enforcement）

<enforcement_metadata>
name: "Prompt Engineering Enforcement"
version: "1.0"
category: "prompt_engineering"
locale: "zh"
prompt_techniques: ["chain_of_thought", "self_discover", "xml_structured", "evidence_based", "deterministic_execution", "multi_agent_coordination", "fast_stop_mechanism"]
quality_standards: ["objectivity", "consistency", "traceability", "actionability", "security", "performance"]
<!-- enforcement_metadata>

## 1. 核心優秀實踐（3-4 條）

- **結構化、可機器校驗輸出**：複雜推理與結論以 XML 區塊輸出；面向人讀者的章節轉為 Markdown。強制模式一致性與占位符清理。
- **可執行的推理框架**：將 Chain-of-Thought（簡明、可審計）與 SELF-DISCOVER（SELECT/ADAPT/IMPLEMENT/APPLY）固化為工作流階段及其輸入/輸出。
- **以證據為本、可追溯**：任何判斷必須附可驗證證據（檔案路徑、行範圍、PR 連結、量化指標），確保可重現。
- **決定論與安全並行（含快停機制）**：在執行/校驗任務使用決定論解碼與穩定排序；允許同階段內安全並行；實作快速止損觸發與最小可交付輸出。

## 2. 標準化 XML 標籤（標籤註冊表）

以下標籤用於統一結構化輸出；除標註（required）外屬性皆為可選。

- **`<metadata>`**：文件上下文
  - 子項：`<name>`, `<version>`, `<category>`, `<task_id>`, `<timestamp>`
- **`<prerequisites>`**：前置條件與所需檔案
  - 子項 `<file path="…" required="true|false|recommended">`
    - 子標籤 `<failure_action>`：`emergency_stop|record_warning_continue|minimal_viable_output`
- **`<determinism>`**：解碼與排序要求
  - 屬性：`temperature`, `top_p`, `top_k`, `seed`, `stable_sort="true|false"`
- **`<workflow>`**：階段化執行模型
  - 子項 `<stage id="S#" name="…" optional="true|false" parallel="allowed|forbidden">`
    - 子標籤：`<inputs>`, `<actions>`, `<outputs>`, `<quality_gates>`, `<checklist>`
- **`<self_discover>`**：推理框架容器
  - 子標籤：`<select>`, `<adapt>`, `<implement>`, `<apply>`
- **`<reasoning>`**：分析與結論
  - 子標籤：`<analysis>`, `<findings>`, `<decisions>`, `<rationale>`, `<validation>`
- **`<evidence>`**：證據引用（可追溯）
  - 屬性：`path`（required）, `start_line`, `end_line`, `sha256`
- **`<quality_gates>`**：品質柵欄
  - 子項 `<gate name="…">`，含 `<criteria>`, `<threshold>`, `<failure_action>`
- **`<fast_stop_mechanism>`**：快速止損
  - 子標籤：`<trigger_conditions>`, `<minimal_viable_output>`
- **`<security>`**：安全與合規
  - 子標籤：`<read_only_paths>`, `<sensitive_filters>`, `<access_control>`
- **`<output>`**：輸出與交付
  - 子標籤：`<report>`, `<summary>`, `<details>`, `<checklist>`

### 最小範例

```xml
<prompt_enforcement>
  <metadata>
    <name>Prompt Engineering Enforcement</name>
    <version>1.0</version>
    <category>prompt_engineering</category>
    <task_id>123</task_id>
    <timestamp>2025-01-01T00:00:00Z</timestamp>
  </metadata>

  <prerequisites>
    <file path="sunnycore/dev/workflow/developer-orchestrator-workflow.md" required="recommended">
      <failure_action>record_warning_continue</failure_action>
    </file>
    <file path="sunnycore/po/templates/implementation-plan-tmpl.yaml" required="false"/>
  </prerequisites>

  <determinism temperature="0" top_p="0" top_k="1" seed="42" stable_sort="true"/>

  <workflow>
    <stage id="S1" name="discovery" parallel="allowed">
      <inputs>
        <source path="docs/specs/task.md" required="true"/>
      </inputs>
      <actions>
        <self_discover>
          <select>選擇合適的分析方法</select>
          <adapt>依專案限制調整</adapt>
          <implement>制定結構化執行計畫</implement>
          <apply>執行並收集輸出</apply>
        </self_discover>
      </actions>
      <outputs>
        <evidence path="docs/specs/task.md" start_line="1" end_line="50" sha256="…"/>
      </outputs>
      <quality_gates>
        <gate name="inputs_loaded">
          <criteria>所有必需輸入就緒</criteria>
          <threshold>100%</threshold>
          <failure_action>emergency_stop</failure_action>
        </gate>
      </quality_gates>
    </stage>
  </workflow>

  <reasoning>
    <analysis>分解目標與風險</analysis>
    <findings>關鍵限制已識別</findings>
    <decisions>採用決定論解碼</decisions>
    <rationale>提升可重現性</rationale>
    <validation>與模板交叉驗證</validation>
  </reasoning>

  <output>
    <report>
      <summary>輸入驗證完成；品質柵欄通過</summary>
      <details>具證據引用的結構化發現</details>
      <checklist>
        <item checked="true">無殘留占位符</item>
      </checklist>
    </report>
  </output>

  <fast_stop_mechanism>
    <trigger_conditions>
      <missing_prerequisite>
        <condition>關鍵模板缺失</condition>
        <action>immediate_stop</action>
      </missing_prerequisite>
    </trigger_conditions>
    <minimal_viable_output>
      <status>EMERGENCY_STOP</status>
      <partial_results>summary</partial_results>
    </minimal_viable_output>
  </fast_stop_mechanism>
</prompt_enforcement>
```

## 3. 執行規範（Enforcement Protocol）

### 3.1 前置條件
- 能讀取統一工作流與模板者盡量載入；若失敗記錄於 `validation_warnings`，除 `required="true"` 且需 `emergency_stop` 情況外持續執行。
- 嚴守領域邊界與存取規則（例如不得修改 `docs/specs/**`）。

### 3.2 執行規則
- 決定論：`temperature=0`, `top_p=0`, `top_k=1`, 固定 `seed`，清單採字典序穩定排序。
- 並行：允許同階段只讀探索並行；跨階段順序必須保持。
- 快取：基於內容雜湊的快取；檔案雜湊/mtime 變更時失效。

### 3.3 證據與追溯
- 任何主張都需以 `<evidence path start_line end_line sha256?>` 引用。
- 優先提供精確行範圍，並附上可重現量測。

### 3.4 結構化輸出與 Markdown 轉換
- 複雜分析區塊必須使用本文件定義的 XML 標籤。
- 需轉 Markdown 的模板遵循：
  - 標題：YAML 區段 → `#` 至 `######`
  - 清單：陣列 → `-` 或編號清單
  - 程式碼：使用對應語言的 fenced code block
  - 表格：必要時使用 `| Field | Value |`
  - 連結：`[text](URL)`；清除占位符與 N/A 註記

### 3.5 品質柵欄（Quality Gates）
- Gate 1：前置驗證（100%，失敗 → emergency stop）
- Gate 2：證據完整性（100% 發現具引用；失敗 → continue_with_warnings）
- Gate 3：結構化輸出符合度（≥95%；失敗 → require_improvement）
- Gate 4：安全合規（100%；失敗 → emergency stop）

### 3.6 安全與合規
- 規範資料夾唯讀；敏感資訊過濾；強制存取控制。

### 3.7 快速止損與最小可交付輸出
- 為缺失 enforcement/工作流/模板等情況設置觸發；觸發後產生最小報告，描述已完成比例與恢復步驟。

### 3.8 輸出位置
- 建議：`{{project_root}}/docs/prompt/enforcement/`（如不存在可建立）。

## 4. 檢查清單（Checklists）

### 前置檢查
- [ ] 已載入工作流與模板或完成警示記錄
- [ ] 已套用決定論設定與穩定排序
- [ ] 已確認領域邊界與存取規則

### 執行檢查
- [ ] XML 區塊符合標籤註冊表
- [ ] 所有發現皆具 `<evidence>` 引用
- [ ] 同階段並行未破壞依賴關係

### 報告檢查
- [ ] Markdown 轉換完成且無占位符
- [ ] 品質柵欄通過既定閾值
- [ ] 安全合規校驗通過

## 5. Enforcement 文件的核心組成模式

基於對現有執行規範文件的分析，以下是 LLM 規範文件的標準化組成結構：

### 5.1 文件頭部結構
- **文檔標題與概述**：清楚說明此規範的目的與適用範圍
- **高級提示技術整合**：明確列出使用的提示技術（Chain of Thought、SELF-DISCOVER、XML 結構化等）
- **品質標準宣告**：定義客觀性、一致性、可追溯性、可操作性、安全性、效能要求

### 5.2 核心執行協議（Core Execution Protocol）
必須包含以下結構化區塊：

#### 5.2.1 強制前置條件（Mandatory Prerequisites）
```xml
<prerequisites>
  <workflow_file>
    <path>{specific_path}</path>
    <requirement>mandatory|recommended|optional</requirement>
    <failure_action>emergency_stop|record_warning_continue|minimal_viable_output</failure_action>
  </workflow_file>
  <!-- 其他必要文件 -->
</prerequisites>
```

#### 5.2.2 工作流合規性（Workflow Compliance）
- **階段完整性**：絕不跳過工作流階段，按序執行所有階段
- **並行處理規則**：明確定義允許並行的操作範圍
- **依賴關係管理**：確保階段間依賴關係的正確處理

#### 5.2.3 領域特定要求（Domain-Specific Requirements）
根據不同代理類型定義：
- **安全要求**：資料保護、存取控制、敏感資訊處理
- **效能要求**：延遲目標、吞吐量目標、記憶體使用限制
- **測試要求**：測試覆蓋率、測試類型、品質門檻
- **架構原則**：SOLID 原則、清潔架構、錯誤處理

### 5.3 品質門檻系統（Quality Gates System）
標準化的多層品質驗證：

```xml
<quality_gates>
  <gate1 name="prerequisite_validation">
    <criteria>所有強制檔案可存取且有效</criteria>
    <threshold>100%</threshold>
    <failure_action>emergency_stop</failure_action>
  </gate1>
  <!-- 其他品質門檻 -->
</quality_gates>
```

### 5.4 快速止損機制（Fast-Stop Mechanism）
系統化的失敗檢測與處理：

```xml
<fast_stop_mechanism>
  <trigger_conditions>
    <missing_enforcement>
      <condition>關鍵規範檔案不存在或無效</condition>
      <action>immediate_stop</action>
      <output>emergency_stop_template</output>
    </missing_enforcement>
  </trigger_conditions>
  <minimal_viable_output>
    <status>緊急狀態碼</status>
    <partial_results>部分結果摘要</partial_results>
    <recovery_steps>恢復步驟</recovery_steps>
  </minimal_viable_output>
</fast_stop_mechanism>
```

### 5.5 安全與合規標準（Security and Compliance）

```xml
<security_compliance>
  <access_control>
    <read_only_paths>
      <path>docs/specs/**</path>
      <exception>特定工作流 FAIL 分支執行期間</exception>
    </read_only_paths>
    <write_permissions>
      <path>允許寫入的路徑列表</path>
    </write_permissions>
  </access_control>
  <data_protection>
    <sensitive_information_filtering enabled="true"/>
    <credential_scanning enabled="true"/>
    <pii_detection enabled="true"/>
  </data_protection>
</security_compliance>
```

### 5.6 效能與效率標準（Performance Standards）

```xml
<performance_standards>
  <execution_timeouts>
    <total_execution_time max="900s"/>
    <individual_timeout max="300s"/>
  </execution_timeouts>
  <resource_limitations>
    <memory_usage max="512MB"/>
    <file_operations max="1000"/>
  </resource_limitations>
</performance_standards>
```

### 5.7 監控與報告框架（Monitoring Framework）

```xml
<monitoring_framework>
  <execution_tracking>
    <phase_completion_tracking enabled="true"/>
    <quality_gate_monitoring enabled="true"/>
  </execution_tracking>
  <reporting_requirements>
    <execution_summary required="true"/>
    <compliance_status required="true"/>
  </reporting_requirements>
</monitoring_framework>
```

### 5.8 失敗處理協議（Failure Handling Protocol）
系統化的錯誤恢復機制：
- **分類處理**：根據失敗類型採用不同的恢復策略
- **優雅降級**：在資源受限時減少分析範圍
- **部分結果交付**：在受控條件下接受部分結果
- **重試策略**：指數退避機制，最多 3 次重試

## 6. 多代理協調標準（Multi-Agent Coordination）

### 6.1 並行執行框架
```xml
<multi_agent_coordination>
  <parallel_execution_framework>
    <agent_distribution>
      <agent id="agent_name" max_parallel="1" timeout="300s" binding="data_source"/>
    </agent_distribution>
    <barrier_synchronization>
      <checkpoint name="checkpoint_name">
        <required_agents>all|4_of_5|majority</required_agents>
        <timeout>60s</timeout>
        <failure_action>emergency_stop|continue_with_warnings</failure_action>
      </checkpoint>
    </barrier_synchronization>
  </parallel_execution_framework>
</multi_agent_coordination>
```

### 6.2 通訊協議
- **訊息格式**：標準化 JSON 格式，包含必要欄位
- **狀態管理**：記憶體內 JSON 儲存，最後寫入者勝出衝突解決
- **版本控制**：啟用版本管理確保一致性

## 7. 高級提示技術整合要求

### 7.1 Chain of Thought 推理整合
- **應用場景**：複雜分析、同步驗證、問題診斷
- **實作要求**：「問題理解 → 分析分解 → 逐步推理 → 結論驗證」
- **輸出要求**：分析過程清晰可見，推理步驟邏輯連貫

### 7.2 SELF-DISCOVER 框架整合
- **SELECT 階段**：選擇適當的分析方法與工具
- **ADAPT 階段**：根據專案特性調整方法
- **IMPLEMENT 階段**：制定結構化執行計畫
- **APPLY 階段**：執行計畫並產生結果

### 7.3 XML 結構化輸出要求
- **標籤正確性**：XML 標籤使用必須正確且一致
- **內容結構化**：複雜內容必須使用適當 XML 標籤組織
- **語意清晰性**：標籤語意必須清楚且有意義

## 8. 實作指導原則

### 8.1 對執行代理的要求
- **嚴格合規**：所有代理必須無例外地實作這些執行標準
- **XML 驗證**：對所有規則合規檢查實作 XML 模式驗證
- **錯誤處理**：根據失敗處理協議實作優雅降級
- **效能監控**：追蹤並報告相對於既定標準的效能指標
- **安全意識**：實作所有安全與資料保護要求

### 8.2 對系統整合者的要求
- **配置管理**：對所有標準實作集中式配置管理
- **監控整合**：與既有監控和告警系統整合
- **合規稽核**：實作定期合規稽核與報告
- **效能優化**：在既定約束條件內持續優化系統效能
- **安全加固**：根據組織政策需求實作額外安全措施

## 9. 參考與相容性
- 與既有 enforcement 對齊：commit orchestrator、file classifier、implementation plan validator、architecture documenter、knowledge curator、review orchestrator。
- 吸收社群實踐：Conventional Commits、Keep a Changelog、XML/JSON 結構化輸出、決定論評估以提升可重現性。
- 整合高級提示技術：Chain of Thought、SELF-DISCOVER、XML 結構化輸出、證據基礎評估。
