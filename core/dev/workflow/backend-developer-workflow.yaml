---
# Backend Developer å·¥ä½œæµç¨‹
# å°ˆç‚ºå¾Œç«¯é–‹ç™¼è€…è¨­è¨ˆçš„è¨ˆåŠƒé©…å‹•å·¥ä½œæµç¨‹
template: backend-developer-workflow
version: 2.0

workflow:
  name: "Backend Developer è¨ˆåŠƒé©…å‹•å·¥ä½œæµç¨‹"
  description: "å°ˆç‚ºå¾Œç«¯é–‹ç™¼è€…è¨­è¨ˆçš„å·¥ä½œæµç¨‹ï¼Œå°ˆæ³¨æ–¼ä¼ºæœå™¨æ¶æ§‹ã€APIè¨­è¨ˆå’Œç³»çµ±å¯æ“´å±•æ€§"
  enforcement_level: "lenient"
  halt_on_validation_failure: false
  default_profile: "fast_strict"

# === è¼¸å…¥å®šç¾© ===
inputs:
  task_id: "<required>"
  plan_path: "<auto>"
  project_root: "<auto>"
  developer_type: "backend"

# === è¨ˆåŠƒè§£æé…ç½® ===
plan_resolution:
  find_by_task_id: true
  search_paths:
    - "{{project_root}}/docs/implementation-plan"
  supported_extensions:
    - "yaml"
    - "yml" 
    - "md"
  expectations:
    template: "implementation-plan"
    version: 1

# === ç¯„åœç®¡æ§ ===
guardrails:
  scope_source: "scope"
  out_of_scope_is_blocking: false
  on_scope_violation: "record_warning_and_continue"

# === å‰ç½®æ¢ä»¶ ===
preconditions:
  - "è¨ˆåŠƒæ–‡ä»¶å­˜åœ¨æ–¼docs/implementation-plan/*ä¸¦åŒ¹é…task_id"
  - "è¨ˆåŠƒç¯„æœ¬ç‰ˆæœ¬ == 1"
  - "metadataåŒ…å«task_idã€project_nameã€ownerã€date"
  - "sourcesè·¯å¾‘è§£æ"
  - "assumptionså’Œconstraintså·²ç¢ºèª"

# === åŸ·è¡Œå”è­° ===
execution_protocol:
  
  enforcement_compliance:
    mandatory_enforcement_file: "/Users/tszkinlai/Coding/AI workflow/core/dev/enforcement/backend-developer-enforcement.md"
    note: "æ‰€æœ‰è©³ç´°çš„å¼·åˆ¶åŸ·è¡Œè¦å‰‡ã€é©—è­‰æ¨™æº–å’ŒåŸ·è¡Œè¦æ±‚éƒ½åœ¨å¾Œç«¯å¼·åˆ¶åŸ·è¡Œæ–‡ä»¶ä¸­å®šç¾©"

output_contracts:
  objectives: { $ref: "#/schemas/objectives_v1" }
  modules: { $ref: "#/schemas/modules_v1" }

schemas:
  objectives_v1:
    $id: "schemas/objectives_v1"
    type: object
    required: ["F-IDs", "N-IDs", "acceptance_criteria"]
    properties:
      F-IDs:
        type: array
        items:
          type: string
          pattern: "^F-[0-9]+$"
        minItems: 1
      N-IDs:
        type: array
        items:
          type: string
          pattern: "^N-[0-9]+$"
      acceptance_criteria:
        type: array
        items:
          type: object
          required: ["F-ID", "criteria"]
          properties:
            F-ID:
              type: string
              pattern: "^F-[0-9]+$"
            criteria:
              type: array
              items:
                type: string
        minItems: 1
    additionalProperties: false

  modules_v1:
    $id: "schemas/modules_v1"
    type: object
    required: ["modules"]
    properties:
      modules:
        type: array
        items:
          type: object
          required: ["name", "interfaces"]
          properties:
            name:
              type: string
            interfaces:
              type: array
              items:
                type: object
                required: ["name", "methods"]
                properties:
                  name:
                    type: string
                  methods:
                    type: array
                    items:
                      type: object
                      required: ["name", "inputs", "outputs"]
                      properties:
                        name: { type: string }
                        inputs:
                          type: array
                          items:
                            type: object
                        outputs:
                          type: object
            reuse:
              type: array
              items:
                type: string
    additionalProperties: false

# === éšæ®µå®šç¾© ===
# è©³ç´°çš„é©—è­‰è¦å‰‡å’Œå“è³ªæ¨™æº–åœ¨backend enforcementæ–‡ä»¶ä¸­å®šç¾©
validation_rules:
  note: "è©³ç´°çš„é©—è­‰è¦å‰‡å’Œå“è³ªæ¨™æº–å®šç¾©åœ¨å¾Œç«¯å¼·åˆ¶åŸ·è¡Œæª”æ¡ˆä¸­"
  
  stage_sequence:
    - workflow_initialization
    - scope_comprehension
    - objectives_and_acceptance
    - architecture_and_modules
    - tdd_cycle_planning
    - tests_first
    - implementation
    - quality_gates
    - milestones_timeline
    - dependencies
    - estimation_tracking
    - risks_changes
    - definition_of_done

  error_handling:
    validation_errors:
      missing_stage:
        severity: "warning"
        message: "å¼·åˆ¶éšæ®µæœªå®Œæˆ"
        action: "append_warning_and_continue"
      
      scope_violation:
        severity: "warning"
        message: "å¯¦ä½œè¶…å‡ºå®šç¾©ç¯„åœ"
        action: "append_warning_and_continue"
      
      missing_tests:
        severity: "warning"
        message: "å¯¦ä½œå‰æœªæ’°å¯«æ¸¬è©¦"
        action: "append_warning_and_continue"
      
      tdd_violation:
        severity: "warning"
        message: "é•åTDDå¾ªç’° - æ‡‰å…ˆæ’°å¯«æ¸¬è©¦"
        action: "append_warning_and_continue"

  format_contracts:
    - stage: "objectives_and_acceptance"
      must_validate_against: "objectives"
      on_failure: "append_warning_and_continue"
    - stage: "architecture_and_modules"
      must_validate_against: "modules"
      on_failure: "append_warning_and_continue"
    - stage: "tdd_cycle_planning"
      must_validate_against: "tdd_plan"
      on_failure: "append_warning_and_continue"

# === å·¥ä½œæµç¨‹éšæ®µ ===
stages:
  - id: "workflow_initialization"
    title: "å·¥ä½œæµç¨‹åˆå§‹åŒ–"
    mandatory: true
    validation_checkpoint: true
    actions:
      - load: ["/Users/tszkinlai/Coding/AI workflow/core/dev/workflow/backend-developer-workflow.yaml"]
      - detect_developer_type: "backend"
      - resolve_plan_by_task_id: true
      - verify_preconditions: true

  - id: "scope_comprehension"
    title: "ç¯„åœç†è§£"
    mandatory: true
    validation_checkpoint: true
    actions:
      - read: ["context.summary", "context.background", "context.goals"]
      - copy_to_notes: ["context.goals"]
      - review: ["scope.in_scope", "scope.out_of_scope"]
      - check_for_existing_implementation:
          - scan_codebase_for_related_changes: true
          - identify_existing_patterns_and_dependencies: true
          - understand_current_implementation_state: true
          - note_potential_conflicts_with_current_scope: true

  - id: "objectives_and_acceptance"
    title: "ç›®æ¨™èˆ‡é©—æ”¶"
    mandatory: true
    validation_checkpoint: true
    actions:
      - extract_functional_objectives_as: "F-IDs"
      - extract_non_functional_objectives_as: "N-IDs"
      - attach_acceptance_criteria: true

  - id: "architecture_and_modules"
    title: "æ¶æ§‹èˆ‡æ¨¡çµ„"
    mandatory: true
    validation_checkpoint: true
    actions:
      - read: ["approach.architecture_overview"]
      - for_each: "approach.modules"
        do:
          - define_first: "interfaces"
          - identify: "reuse"
          - create: "module_skeletons_with_feature_flags"

  - id: "tdd_cycle_planning"
    title: "TDDå¾ªç’°è¦åŠƒ"
    mandatory: true
    validation_checkpoint: true
    actions:
      - plan_tdd_cycles_per: "F-IDs"
      - define_test_scenarios_for_each: "acceptance_criteria"
      - identify_test_data_requirements: true
      - plan_mock_and_stub_strategies: true
      - define_test_environment_setup: true
      - create_tdd_iteration_plan: true

  - id: "tests_first"
    title: "æ¸¬è©¦å„ªå…ˆ (TDDç´…éšæ®µ)"
    mandatory: true
    validation_checkpoint: true
    actions:
      - ğŸš¨_TDD_MANDATORY: "å¯¦ä½œå‰å¿…é ˆå…ˆæ’°å¯«æ¸¬è©¦"
      - unit_tests_per_module_aligned_to: "F-IDs"
      - integration_tests_for: ["interfaces", "routing", "api_flows", "failure_paths"]
      - acceptance_tests_mirroring: "acceptance_criteria_per_F-ID"
      - contract_tests_for: ["api_contracts", "service_interfaces"]
      - ensure_tests_fail_initially: "TDDç´…éšæ®µ"
      - document_test_behavior_expectations: true
      - create_test_data_fixtures: true

  - id: "implementation"
    title: "å¯¦ä½œ (TDDç¶ éšæ®µ)"
    mandatory: true
    validation_checkpoint: true
    actions:
      - ğŸš¨_TDD_ENFORCEMENT: "å¯¦ä½œæœ€å°‘ç¨‹å¼ç¢¼ä»¥é€šéæ¸¬è©¦"
      - implement_handlers_and_components_per: ["interfaces", "F-IDs"]
      - run_tests_after_each_change: "ä¿æŒæ¸¬è©¦ç¶ ç‡ˆ"
      - draft_idempotent_reversible_migrations: true
      - define_ordered_steps_and_backout: true
      - run_in_non_prod_first: true
      - implement_authentication_authorization: true
      - validate_input_sanitization: true
      - ensure_proper_error_handling: true
      - meet_latency_throughput_memory_targets: true
      - implement_proper_logging_monitoring: true
      - enforce_constraints: true
      - traceability:
          reference_task_id: "metadata.task_id"
          in: ["PR_titles", "commits", "code_annotations"]

  - id: "quality_gates"
    title: "å“è³ªé–€æª» (TDDé‡æ§‹éšæ®µ)"
    mandatory: true
    validation_checkpoint: true
    actions:
      - ğŸš¨_TDD_REFACTOR: "åœ¨ä¿æŒæ¸¬è©¦ç¶ ç‡ˆçš„æƒ…æ³ä¸‹é‡æ§‹"
      - ensure: "coverage_and_static_analysis_thresholds >= quality_gates"
      - validate_non_functional: "N-IDs_measurements"
      - security_checks: ["dependencies", "SAST", "api_security_audit"]
      - performance_testing: ["latency", "throughput", "memory_usage"]
      - refactor_code_while_maintaining_behavior: true
      - improve_code_structure_and_readability: true
      - eliminate_code_duplication: true
      - optimize_performance_without_breaking_tests: true

  - id: "milestones_timeline"
    title: "é‡Œç¨‹ç¢‘èˆ‡æ™‚ç¨‹"
    mandatory: true
    validation_checkpoint: true
    actions:
      - map_dev_tasks_to: "milestones.schedule"
      - mark_done_when: "milestones.done_definition_satisfied"

  - id: "dependencies"
    title: "ä¾è³´é …"
    mandatory: true
    validation_checkpoint: true
    actions:
      - verify_versions_and_SLAs: "dependencies.external"
      - coordinate_internal_owners: "dependencies.internal"

  - id: "estimation_tracking"
    title: "ä¼°ç®—èˆ‡è¿½è¹¤"
    mandatory: true
    validation_checkpoint: true
    actions:
      - report_progress_using: "estimation.method"
      - keep_remaining_effort_per_work_item: true
      - update_confidence_against: "estimation.summary.confidence"

  - id: "risks_changes"
    title: "é¢¨éšªèˆ‡è®Šæ›´"
    mandatory: true
    validation_checkpoint: true
    actions:
      - review_weekly: "risks"
      - on_realized_risk: ["execute_mitigation", "then_contingency"]
      - on_scope_creep: "open_question_and_pause"

  - id: "definition_of_done"
    title: "å®Œæˆå®šç¾©"
    mandatory: true
    validation_checkpoint: true
    actions:
      - require: [
          "all_F-IDs_pass_acceptance_tests",
          "all_N-IDs_verified_by_measurement",
          "no_unresolved_open_questions",
          "PRs_merged_CI_green"
        ]

# å¾Œç«¯å°ˆæ¥­åŒ–éœ€æ±‚ç¾åœ¨å®šç¾©åœ¨backend-developer-enforcement.mdä¸­
# é€™ç¢ºä¿äº†å·¥ä½œæµç¨‹ç¨‹åºå’Œå¼·åˆ¶åŸ·è¡Œè¦å‰‡ä¹‹é–“çš„æ¸…æ¥šåˆ†é›¢

# === é—œéµæˆåŠŸå› ç´  ===
critical_success_factors:
  - "é¦–å…ˆè®€å–å·¥ä½œæµç¨‹å’Œè¨ˆåŠƒæª”æ¡ˆ - çµ•ä¸åœ¨æ²’æœ‰å®ƒå€‘çš„æƒ…æ³ä¸‹é–‹å§‹"
  - "ä¿æŒåœ¨ç¯„åœé‚Šç•Œå…§ - å°ä»»ä½•ç¯„åœå•é¡Œæš«åœ"
  - "å°‡ç›®æ¨™æå–ç‚ºF-IDså’ŒN-IDs - ç¶­æŒå¯è¿½æº¯æ€§"
  - "ğŸš¨ TDDå¼·åˆ¶è¦æ±‚ï¼šå¯¦ä½œå‰å…ˆæ’°å¯«æ¸¬è©¦ - ç´…éšæ®µå„ªå…ˆ"
  - "ğŸš¨ TDDå¼·åˆ¶åŸ·è¡Œï¼šå¯¦ä½œæœ€å°‘ç¨‹å¼ç¢¼ä»¥é€šéæ¸¬è©¦ - ç¶ éšæ®µ"
  - "ğŸš¨ TDDé‡æ§‹ï¼šåœ¨ä¿æŒæ¸¬è©¦ç¶ ç‡ˆçš„æƒ…æ³ä¸‹é‡æ§‹ - é‡æ§‹éšæ®µ"
  - "é¦–å…ˆå®šç¾©ä»‹é¢å’Œæ¶æ§‹ - éµå¾ªè¨ˆåŠƒçµæ§‹"
  - "ç¶­æŒå¯è¿½æº¯æ€§ - åœ¨PRã€æäº¤ã€ç¨‹å¼ç¢¼ä¸­åŒ…å«task_id"
  - "é”åˆ°å“è³ªé–€æª» - è¦†è“‹ç‡ã€éœæ…‹åˆ†æã€æ•ˆèƒ½ã€å®‰å…¨æ€§"
  - "éµå¾ªé‡Œç¨‹ç¢‘å’Œæ™‚ç¨‹ - æº–ç¢ºè¿½è¹¤é€²åº¦"
  - "ç®¡ç†é¢¨éšªå’Œä¾è³´é … - èˆ‡è² è²¬äººå”èª¿"
  - "å®Œæˆå®Œæˆå®šç¾© - æ‰€æœ‰æ¨™æº–å¿…é ˆæ»¿è¶³"
  - "çµ•ä¸è·³éTDDå¾ªç’° - å¿…é ˆå…ˆæ’°å¯«æ¸¬è©¦"
  - "åœ¨æ•´å€‹å¯¦ä½œéç¨‹ä¸­ä¿æŒæ¸¬è©¦ç¶ ç‡ˆ - TDDå®‰å…¨åŸå‰‡"

# === å·¥ä½œæµç¨‹é•è¦å›æ‡‰ ===
workflow_violation_responses:
  - "ç¼ºå°‘éšæ®µåŸ·è¡Œï¼šé™„åŠ è­¦å‘Šä¸¦ç¹¼çºŒ"
  - "ç¯„åœé•è¦ï¼šé™„åŠ è­¦å‘Šä¸¦ç¹¼çºŒï¼›éåŒæ­¥é–‹å•Ÿå•é¡Œ"
  - "è¨ˆåŠƒåé›¢ï¼šé™„åŠ è­¦å‘Šï¼›è¨˜éŒ„æ±ºå®š"
  - "ğŸš¨ TDDé•è¦ï¼šåš´é‡è­¦å‘Š - å¿…é ˆåœ¨å¯¦ä½œå‰æ’°å¯«æ¸¬è©¦"
  - "ç¼ºå°‘æ¸¬è©¦ï¼šé™„åŠ è­¦å‘Šï¼›åœ¨ä¸‹æ¬¡è¿­ä»£ä¸­å„ªå…ˆä¿®å¾©"
  - "å“è³ªé–€æª»å¤±æ•—ï¼šé™„åŠ è­¦å‘Šï¼›åŒ…å«æ¸¬é‡å’Œä¿®å¾©è¨ˆåŠƒ"
  - "ç¼ºå°‘å¯è¿½æº¯æ€§ï¼šé™„åŠ è­¦å‘Šï¼›äº‹å¾Œæ·»åŠ task_idåƒè€ƒ"
  - "ğŸš¨ TDDå¾ªç’°ä¸å®Œæ•´ï¼šé™„åŠ è­¦å‘Šï¼›ç¢ºä¿å®Œæˆç´…-ç¶ -é‡æ§‹å¾ªç’°"
