# Implementation Plan Validator 強制執行規範

## 核心執行協議

-### 必要前置條件（寬鬆）
- **建議**：在開始驗證前載入所有必要文件；若缺失，記錄為 validation_warnings 並持續
- **建議讀取順序**：
  1. `/User/tszkinlai/Coding/AI workflow/core/enforcement/implementation-plan-validator-enforcement.md`
  2. `/User/tszkinlai/Coding/AI workflow/core/workflow/unified-plan-validation-workflow.yaml`
  3. `/User/tszkinlai/Coding/AI workflow/core/templates/implementation-plan-tmpl.yaml`
  4. `/User/tszkinlai/Coding/AI workflow/core/templates/plan-validation-report-tmpl.yaml`
- **檔案載入驗證**：未能完全載入時，記錄缺口與替代資訊來源

### 基於證據的驗證（絕對強制）
- **證據要求**：所有判斷都必須有具體證據支持
- **引用格式**：必須包含檔案路徑、行號、段落引用
- **可追溯性**：每個發現都必須能追溯到源文件
- **客觀性**：避免主觀判斷，只基於可驗證的事實

### 工作流程合規性（寬鬆）
- **階段完整性**：應按順序執行；未完成時記錄原因與補救計劃
- **驗證檢查點**：未通過時記錄警告並最小化持續
- **失敗處理**：非阻斷性失敗記錄為警告並持續；阻斷性才停止

### 範本合規性（強制但不中斷）
- **結構驗證**：計劃必須符合 `implementation-plan` 範本的必需欄位
- **完整性檢查**：所有必需部分都必須有實際內容
- **佔位符清除**：應清除 `<placeholder>`；殘留時記錄並補齊計劃
- **格式一致性**：必須符合範本的格式要求

### 交叉參考驗證（強制執行）

#### 需求交叉參考
- **功能性需求**：每個功能項目都必須能在 `requirements.md`、`task.md` 或 `design.md` 中找到對應
- **非功能性需求**：測量目標必須清晰且可追溯到規範或品質門檻
- **需求完整性**：所有提及的需求都必須有明確的源頭

#### 設計交叉參考
- **架構對齊**：架構、模組、介面必須能在 `design.md` 中追溯
- **設計文件**：設計圖表和文件必須與計劃一致
- **技術選型**：技術選擇必須有設計文件支持

#### 範圍交叉參考
- **範圍界定**：in_scope/out_of_scope 必須能追溯到規範中的明確邊界定義
- **範圍一致性**：範圍定義必須與專案文件一致
- **範圍合理性**：範圍大小必須與資源和時間安排匹配

### 專案規範合規性（強制驗證）
- **安全要求**：絕不修改 `docs/specs/` 中的任何檔案
- **檔案完整性**：所有引用的檔案必須存在且可讀
- **路徑正確性**：所有檔案路徑必須正確且可解析

### 詳細驗證要求

#### 中繼資料驗證（強制檢查）
- **路徑存在性**：所有引用的路徑必須存在且可讀
- **檔案完整性**：確保所有源文件完整且未損壞
- **版本一致性**：確保文件版本間的一致性

#### 目標驗證（強制執行）
- **功能性目標**：每個項目必須有 `requirements.md`、`task.md` 或 `design.md` 中的對應支持
- **非功能性目標**：測量目標必須清晰、可測量且可追溯
- **目標可達性**：目標必須在給定的約束下可實現

#### 範圍驗證（強制確認）
- **邊界清晰**：範圍邊界必須明確定義
- **包含合理性**：in_scope 項目必須有充分理由
- **排除合理性**：out_of_scope 項目必須有明確理由
- **範圍追溯**：範圍定義必須能追溯到規範或計劃背景

#### 方法驗證（強制檢查）
- **架構合理性**：架構選擇必須有設計文件支持
- **模組設計**：模組劃分必須合理且可追溯
- **介面定義**：介面設計必須在設計文件中有對應

#### 資料驗證（強制確認）
- **資料結構**：必須基於設計或遷移文件
- **遷移策略**：資料遷移必須有清晰的策略和步驟
- **資料完整性**：確保資料變更不會破壞完整性

#### 測試策略驗證（強制檢查）
- **測試完整性**：測試策略必須涵蓋所有功能點
- **品質門檻**：品質門檻必須具體且可驗證
- **測試可行性**：測試方法必須可行且有效

#### 時間線驗證（強制確認）
- **里程碑合理性**：時間線和里程碑必須合理且可實現
- **依賴關係**：依賴性必須清晰且邏輯一致
- **資源匹配**：時間安排必須與可用資源匹配

#### 風險評估驗證（強制檢查）
- **風險識別**：風險識別必須全面且實際
- **緩解措施**：每個風險都必須有對應的緩解措施
- **應急計劃**：重大風險必須有應急計劃

#### 嚴重性量化（強制約定）
- **等級定義**：
  - 關鍵（Critical）：阻斷工作流程，需立即修復；對應 workflow 規則中的 blocker
  - 重要（High）：顯著影響品質/時程；需在報告前修復或列為優先行動
  - 一般（Medium）：建議修正；不阻斷輸出
  - 建議（Low）：最佳實踐或可改進項
- **量化維度（至少二項）**：影響範圍（scope）、可復現性（reproducibility）、修復成本（effort）、時效敏感度（time criticality）
- **決策規則**：任一阻斷條件（如缺失關鍵章節、交叉參考失敗、佔位符殘留、無證據發現）則歸類為關鍵

### 報告生成要求（強制執行）
- **範本合規**：報告必須符合 `plan-validation-report-tmpl.yaml` 結構
- **內容完整**：所有範本部分都必須有實際內容
- **證據支持**：所有發現都必須有具體證據
- **建議具體**：改進建議必須具體且可操作
 - **執行中繼資料**：建議在附錄中包含 run_id、開始/結束時間、各階段耗時、並行度、快取命中率

### 品質標準（強制達到）
- **客觀性**：驗證必須客觀，基於可驗證的事實
- **全面性**：驗證必須涵蓋計劃的所有重要方面
- **準確性**：所有發現都必須準確且有據可查
- **實用性**：驗證結果必須對改進計劃有實際價值

### 嚴重性評估（強制分類）
- **關鍵**：可能導致專案失敗的問題
- **重要**：可能影響專案品質或時程的問題
- **一般**：可以改進但不影響核心目標的問題
- **建議**：最佳實踐建議

### 文檔和可追溯性
- **證據記錄**：每個發現都必須記錄具體證據
- **引用格式**：使用標準化的引用格式
- **可追溯性**：確保所有判斷都可以追溯到源文件
- **版本控制**：記錄驗證時的文件版本

### 效率與確定性準則（不改變核心流程）
- **預取與並行（允許）**：可在單一階段內對互不相依的讀檔與檢查動作進行並行處理；跨階段仍必須嚴格依序執行與驗證。
- **快取策略（建議）**：基於 `task_id + plan_path + 來源文件雜湊` 建立唯一定址快取；當檔案雜湊或 mtime 變更時無條件失效。
- **決定論推理（建議）**：對使用之 LLM/工具設定 `temperature=0`、`top_p=0`（如支援），關閉隨機取樣；對輸出清單採用穩定排序（區域→路徑→起始行）。
- **Fail-fast（強化）**：一旦出現阻斷級（blocker）缺失/違規，立即停止後續步驟並回到對應階段修復。
- **佔位符掃描（強化）**：在報告輸出前以規則式掃描 `<[^>]+>`、`TBD`、`TODO`、`INSERT` 等佔位符；若命中即視為格式違規。
- **證據最小單位（規範化）**：每條發現至少包含 `檔案相對路徑`、`行範圍`、`引用片段（必要時）`；鼓勵附上來源檔案 `sha256` 以強化可重現性。
- **執行遙測（建議）**：為每次驗證生成 `run_id (UUID)`，記錄各階段開始/完成時間、並行度、快取命中率，寫入報告附錄。

## 驗證檢查清單（強制執行）

### 前置檢查
- [ ] 統一工作流程檔案已載入
- [ ] 實施計劃範本已載入
- [ ] 驗證報告範本已載入
- [ ] 目標計劃檔案存在且可讀

### 結構檢查
- [ ] 計劃符合範本結構
- [ ] 所有必需欄位都有內容
- [ ] 沒有未填充的佔位符
- [ ] 格式符合要求

### 內容檢查
- [ ] 所有功能需求都可追溯
- [ ] 所有非功能需求都可測量
- [ ] 範圍定義清晰且合理
- [ ] 架構設計有文件支持
- [ ] 測試策略完整且可行
- [ ] 時間線合理且可實現
- [ ] 風險評估全面且有緩解措施

### 品質檢查
- [ ] 所有判斷都有證據支持
- [ ] 引用格式正確
- [ ] 建議具體且可操作
- [ ] 嚴重性分類合理

## 失敗處理協議（記錄並續行）
- **文件載入失敗**：記錄缺失與回退路徑；必要時降級範圍
- **計劃檔案不存在**：記錄缺失與替代資訊來源；不中斷收集其他證據
- **交叉參考失敗**：記錄為發現並標註嚴重性與補救建議
- **範本不合規**：記錄差異並提出修正計劃；不中斷
- **證據不足**：記錄缺口與補充計劃；可延後補齊