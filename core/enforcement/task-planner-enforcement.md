# Task Planner 強制執行規範

## 核心執行協議

### 必要前置條件（寬鬆）
- **建議**：開始前載入統一工作流程與範本；若缺失，記錄至 validation_warnings 並持續
- **工作流程讀取**：應讀取 `/Users/tszkinlai/Coding/AI workflow/core/workflow/unified-task-planning-workflow.yaml`，失敗則記錄警告
- **範本讀取**：應讀取 `/Users/tszkinlai/Coding/AI workflow/core/templates/implementation-plan-tmpl.yaml`    ，失敗則記錄警告
- **驗證要求**：若 project_root 未解析或讀取未完整，記錄缺失與替代資訊來源

### 確定性與效率（強制）
- **零隨機**：生成階段必須使用固定參數（temperature≤0.2、top_p≤0.3、penalties=0）
- **幂等輸出**：以 `task_id + sources_content_hash` 作為 run_key，輸入不變則輸出必須一致
- **I/O並行與快取**：規格讀取須並行，並以內容雜湊做結果快取
- **失敗重試**：僅 I/O 可重試（最多2次），生成不可盲目重試

### 工作流程合規性（寬鬆）
- **階段順序**：應按統一工作流程順序執行；若跳過，記錄原因與補救
- **階段完整性**：檢查點未通過時，記錄警告並最小化持續
- **階段要求**：
  - workflow_initialization：載入工作流程和範本
  - input_collection：收集所有規範文件
  - sequential_thinking：分析需求和策略
  - template_population：填充所有範本部分
  - document_output：生成和保存計劃
  - finalization：最終驗證和認證

### 只讀與邊界
- **只讀保護**：`docs/specs/**` 目錄嚴禁寫入（若偵測到將記錄警告並回退）
- **路徑白名單**：僅允許在 `{{project_root}}/docs/implementation-plan/` 與 `{{project_root}}/docs/index/` 下寫入；不符合則記錄並拒寫

### 範本合規性（寬鬆）
- **完整填充**：應以實際內容填充或標記為"N/A - [原因]"；不足時記錄警告
- **佔位符清除**：應清除 `<placeholder>` 值；殘留時記錄以利後續補齊
- **結構一致性**：應符合 `templates/implementation-plan-tmpl.yaml` 結構；不一致時記錄差異
- **黑名單詞彙**：遇 `TBD`/`待定`/`視需要`/`as needed`/`<...>` 時記錄並立即替換或給理由

### Markdown格式轉換（絕對強制）
- **YAML到Markdown**：必須將 `implementation-plan-tmpl.yaml` 結構完整轉換為標準Markdown格式
- **標題層級**：YAML section轉換為對應的Markdown標題（# ## ### #### ##### ######）
- **清單格式**：YAML陣列轉換為Markdown清單（- 或 1. 格式）
- **代碼區塊**：代碼片段、配置範例、測試指令使用標準Markdown代碼塊（```language）
- **表格格式**：需求清單、時程規劃、風險評估使用Markdown表格格式 | 欄位 | 值 |
- **鏈結格式**：文檔參考、規範連結使用標準Markdown鏈結格式 [文字](URL)
- **區塊引用**：重要備註、約束條件使用 > 引用格式
- **強調標記**：使用 **粗體** 和 *斜體* 適當強調關鍵需求和風險
- **進度標示**：使用表情符號標示里程碑狀態（🎯 目標、⚠️ 風險、🔄 進行中）
- **優先級標記**：使用星級或顏色標示需求優先級和風險等級

### 核心規劃原則（強制執行）
1. **安全第一**：絕不修改 `docs/specs/` 中的任何檔案
2. **RCSD合規**：必須定義功能性和非功能性需求；明確範圍界定
3. **MD原則**：必須將工作分解為小型、可重用的模組
4. **KISS原則**：必須偏好最簡單可行的方法
5. **DRY原則**：必須避免重複；重用現有模組
6. **TQA要求**：必須規劃具有明確條件的單元、整合和驗收測試
7. **RACP要求**：必須識別風險和緩解/應急措施
8. **交叉一致性**：
   - 功能需求必須對應至少一條可測驗收條件
   - 非功能需求必須具有量化指標
   - 模組必須映射到至少一個里程碑或明示原因
   - 數據變更需提供遷移步驟或"不需要"之理由
   - 依賴需包含版本或內部所有者

### 上下文和研究要求
8. **上下文保持**：必須包含規範中所有具體技術細節
9. **具體化要求**：必須用具體、可行的細節替換模糊內容
10. **可追溯性**：必須維護計劃元素與來源規範之間的明確連結

### 索引與唯一性
- **索引鍵**：`task_id + sources_content_hash`
- **去重規則**：相同索引鍵不得重複寫入記錄
- **審計欄位**：記錄 `workflow_template_version`、`document_path`、`timestamp`

### 輸出和驗證要求（寬鬆）
11. **專案根目錄解析**：按順序解析 `project_root`：env `CLAUDE_PROJECT_ROOT` → Git root → 最近的 `docs/specs/` → cwd
12. **輸出路徑合規**：必須儲存到 `{{project_root}}/docs/implementation-plan/{{task_id}}-plan.md`
13. **索引更新**：必須將JSONL記錄附加到 `{{project_root}}/docs/index/plan-index.jsonl`
14. **路徑驗證**：必須確保輸出路徑在 `project_root` 下
15. **成功驗證**：應確認檔案成功寫入並回顧絕對路徑；失敗則記錄與重試計劃
16. **終檢擴展**：必須運行黑名單掃描與交叉一致性校驗並全部通過

## 失敗處理協議（記錄並續行）
- **驗證未通過**：記錄警告與缺口；不中斷並列入補回清單
- **檔案載入失敗**：記錄失敗與替代路徑；必要時降級流程
- **範圍解析失敗**：記錄缺口並以最小可行假設繼續；同步提出澄清
- **黑名單命中**：記錄並回退修正；若不能即時修正，列入補回
- **一致性缺陷**：記錄差異與補齊計劃；不中斷

## 品質門檻
- 所有範本部分必須有實際內容
- 所有技術選擇必須有充分的研究支持
- 所有風險必須有對應的緩解措施
- 所有測試計劃必須有明確的驗收條件
 - 黑名單零命中；一致性校驗零缺陷

## SOP（最小閉環）
1. 並行+快取讀取規格（task/requirements/design）
2. 結構化抽取（FR/NFR/約束/依賴→JSON）
3. 模板逐段填充（允許 "N/A - 原因"）
4. Lint（黑名單/佔位符/一致性/Schema）
5. 幂等落盤與索引去重
6. 回讀終檢（模板一致/上下文保真/黑名單與一致性綠燈）