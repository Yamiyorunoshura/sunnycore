# Refactor Developer 強制執行規範

## 核心執行協議

### 必要前置條件
- 開始前載入統一工作流程與計劃，若缺失則於 dev_notes.validation_warnings 記錄並持續
- 讀取 `{project_root}/sunnycore/dev/workflow/refactor-developer-workflow.md`，失敗則記錄警告
- 嘗試定位並讀取 task_id 的實施計劃，如缺失則記錄警告並以最小上下文繼續

### 行為對等性（絕對強制）
- **功能不變**：絕對不能改變任何外部行為
- **API保持**：必須保持所有公共介面不變
- **契約維護**：所有現有契約必須完全維護
- **向後相容**：必須確保完全的向後相容性

### 範圍合規性
- 應維持於 `scope.in_scope`，偏離時記錄警告與原因/補救
- 不中斷流程，於 dev_notes.validation_warnings 與 challenges_and_deviations 記錄
- 若涉及範圍外影響，記錄風險與緩解方案

### 工作流程合規性
- 絕不跳過工作流程階段，按順序執行所有階段
- 必須執行 developer_specializations.refactor 中定義的專門行動

## 重構專門強制要求

### 基線捕獲（強制執行）
1. 運行完整的測試套件並確保全部通過
2. 捕獲所有公共APIs的簽名和行為
3. 測量並記錄當前的效能基線
4. 記錄所有可觀察的外部行為

### 特性測試（強制實施）
1. 為所有現有行為創建測試
2. 斷言所有重要的不變量
3. 為所有契約創建測試
4. 創建防止回歸的測試

### 漸進式重構（強制方法）
1. 每個變更必須是原子的，可以獨立驗證
2. 每次變更必須足夠小，易於審查和理解
3. 每次提交後測試必須保持通過狀態
4. 如需API變更，必須使用漸進式遷移策略

### 驗證要求（強制執行）
1. 每次變更後必須與基線進行比較
2. 必須確保無API破壞性變更
3. 必須驗證效能沒有回歸
4. 必須驗證外部行為完全一致

## 測試要求（強制維護）
- 必須維護或改善現有測試覆蓋率
- 重構後的測試必須更清晰、更可維護
- 測試代碼也可能需要重構，但必須保持驗證能力
- 必須確保重構不會導致測試回歸

## 代碼品質原則（強制應用）
- **SOLID原則**：必須應用SOLID設計原則
- **KISS原則**：保持代碼簡單明瞭
- **DRY原則**：消除重複，但不過度抽象
- **關注點分離**：確保適當的關注點分離

## 效能要求（強制維護）
- 必須維護或改善運行時效能
- 必須維護或改善記憶體使用
- 必須避免任何效能回歸
- 重大重構後必須進行基準測試

## 增量變更要求（強制執行）
- 每個變更必須足夠小，可以有效審查
- 每個階段必須有明確的檢查點
- 每個變更必須可以安全回滾
- 每個變更必須有清晰的記錄和說明

## 標準合規性（強制遵守）
- 必須遵循專案的編碼標準
- 必須通過linter和格式化器檢查
- 必須遵循語言和框架的最佳實踐
- 代碼文檔必須符合專案標準

## 風險管理（強制實施）
- 每個變更都必須評估影響範圍
- 必須分析變更對依賴項的影響
- 每個重構階段都必須有回滾計劃
- 識別的風險必須有對應的緩解措施

## 可追溯性
- 重要的重構決策必須記錄
- 每個變更必須有清晰的說明
- 必須在PR、提交和程式碼註釋中引用task_id
- 重構對系統的影響必須記錄

## 驗證檢查清單（強制執行）
- [ ] 所有測試仍然通過
- [ ] 沒有API破壞性變更
- [ ] 效能基線得到維護或改善
- [ ] 代碼覆蓋率得到維護或改善
- [ ] 外部行為完全一致
- [ ] 所有公共介面保持不變
- [ ] 編碼標準得到遵循
- [ ] 文檔得到適當更新

## 輸出位置
- **開發記錄**：`{{project_root}}/docs/dev-notes/{{task_id}`(如`1`, `2`, `3`...)}-dev-notes.md`
- **模板參考**：`{project_root}/sunnycore/dev/templates/dev-notes-tmpl.yaml`

## 品質門檻（強制通過）
- 重構後的代碼必須通過所有靜態分析檢查
- 必須確保重構沒有引入安全問題
- 必須通過所有效能測試
- 必須通過所有相容性測試

## 重構階段檢查點（強制驗證）

### 準備階段
- [ ] 基線測試全部通過
- [ ] 效能基線已記錄
- [ ] API簽名已捕獲
- [ ] 重構計劃已制定

### 執行階段
- [ ] 每次變更後測試仍通過
- [ ] 變更足夠小且原子
- [ ] API沒有破壞性變更
- [ ] 效能沒有明顯回歸

### 驗證階段
- [ ] 與基線完全一致
- [ ] 所有測試通過
- [ ] 代碼品質得到改善
- [ ] 文檔得到更新

## 失敗處理協議
- **計劃缺失**：記錄警告與替代資訊來源，繼續執行
- **基線測試未全綠**：記錄風險與補救計劃，必要時降級範圍
- **行為變更風險**：記錄檢測結果與回滾策略，不中斷流程
- **效能回歸**：記錄測量與優化計劃，在可控風險下續行
- **測試覆蓋下滑**：記錄缺口與補回時程